# .github/workflows/ipo_alert.yml
#
# Runs alert_runner.py at exactly 3:00 PM IST (09:30 UTC) every weekday.
# IST = UTC + 5:30  →  3:00 PM IST = 09:30 UTC
# Only runs Mon–Fri (Indian market days).
# Also allows manual trigger from GitHub Actions tab for testing.

name: IPO Breakout Alert — 3PM IST

on:
  schedule:
    # 09:30 UTC = 15:00 IST, Mon–Fri
    - cron: '0 9 * * 1-5'

  # Manual trigger — use this to test anytime
  workflow_dispatch:

jobs:
  send-alert:
    name: Run IPO Alert Scanner
    runs-on: ubuntu-latest
    # 108 symbols × 1.5s delay + retries + setup = allow up to 45 min
    timeout-minutes: 45

    steps:
      # ── 1. Checkout repo ────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ── 3. Install Python dependencies ──────────────
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # ── 4. Install Playwright + Chromium ────────────
      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium
          python -m playwright install-deps chromium

      # ── 5. Restore dedup log from cache ─────────────
      # Persists the alerted_symbols.json across daily runs
      # so the cooldown tracker works correctly.
      - name: Restore alert dedup cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: alerted_symbols.json
          key: alerted-symbols-v1

      # ── 6. Run the alert script ──────────────────────
      - name: Run IPO Alert Runner
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python alert_runner.py

      # ── 7. Save updated dedup log to cache ──────────
      # Always saves, even if script errored, so we don't
      # lose the log on a partial run.
      - name: Save alert dedup cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: alerted_symbols.json
          key: alerted-symbols-v1
